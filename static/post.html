<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포스트 상세 - 이지윤</title>
    <link href="/static/css/templatemo-personal-style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav id="navbar">
        <div class="nav-container">
            <a href="/static/index.html" class="logo">Jiyun's</a>
            <ul class="nav-links">
                <li><a href="/static/index.html">Home</a></li>
                <li><a href="/static/index.html#about">About</a></li>
                <li><a href="/static/index.html#portfolio">Blog</a></li>
                <li><a href="/static/index.html#contact">Contact</a></li>
            </ul>
            <div class="mobile-menu-toggle" id="mobileMenuToggle">
                <div class="hamburger"></div>
                <div class="hamburger"></div>
                <div class="hamburger"></div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <ul class="mobile-nav-links">
            <li><a href="/static/index.html">Home</a></li>
            <li><a href="/static/index.html#about">About</a></li>
            <li><a href="/static/index.html#portfolio">Blog</a></li>
            <li><a href="/static/index.html#contact">Contact</a></li>
        </ul>
    </div>

    <!-- Post Detail Section -->
    <section class="post-detail-section" style="min-height: 80vh; padding: 4rem 0;">
        <div class="container">
            <div class="post-detail-content" style="max-width: 800px; margin: 0 auto;">
                <!-- 뒤로가기 버튼 -->
                <div class="back-button" style="margin-bottom: 2rem;">
                    <a href="/static/index.html#portfolio" style="color: #333; text-decoration: none; font-size: 1rem;">
                        ← 블로그로 돌아가기
                    </a>
                </div>

                <!-- 포스트 내용 -->
                <article id="post-detail" style="margin-bottom: 3rem;">
                    <div class="loading" style="text-align: center; color: #666;">포스트를 불러오는 중...</div>
                </article>

                <!-- 댓글 섹션 -->
                <section class="comments-section" style="border-top: 1px solid #eee; padding-top: 2rem;">
                    <h3 style="color: #333; margin-bottom: 1.5rem;">댓글</h3>

                    <!-- 댓글 목록 -->
                    <div id="comments-list" style="margin-bottom: 2rem;">
                        <!-- JavaScript로 동적 생성 -->
                    </div>

                    <!-- 댓글 작성 폼 -->
                    <form id="comment-form" class="comment-form">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label for="author-name" style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: bold;">이름</label>
                            <input type="text" id="author-name" name="author" placeholder="이름을 입력하세요" required
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: #333;">
                        </div>

                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label for="comment-content" style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: bold;">댓글</label>
                            <textarea id="comment-content" name="content" rows="4" placeholder="댓글을 입력하세요..." required
                                      style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: #333; resize: vertical;"></textarea>
                        </div>

                        <button type="submit" class="comment-submit-btn"
                                style="padding: 0.5rem 1.5rem; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            댓글 작성
                        </button>
                    </form>

                    <div id="comment-message" style="margin-top: 1rem; display: none;"></div>
                </section>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-left">
                    <p>&copy; 2025 이지윤 - 백엔드 개발자</p>
                </div>
                <div class="footer-right">
                    <p>꾸준히 성장하는 개발자가 되겠습니다.</p>
                </div>
            </div>
        </div>
    </footer>

<script src="/static/js/templatemo-personal-javascripts.js"></script>
<script>
// URL에서 포스트 ID 가져오기
const urlParams = new URLSearchParams(window.location.search);
const postId = urlParams.get('id');

// 포스트 상세 정보 로드
async function loadPost() {
    if (!postId) {
        document.getElementById('post-detail').innerHTML = '<div style="color: red;">포스트를 찾을 수 없습니다.</div>';
        return;
    }

    try {
        const response = await fetch(`/api/blogs/posts/${postId}/`);
        if (response.ok) {
            const post = await response.json();
            displayPost(post);
            loadComments();
        } else {
            document.getElementById('post-detail').innerHTML = '<div style="color: red;">포스트를 불러올 수 없습니다.</div>';
        }
    } catch (error) {
        console.error('포스트 로딩 실패:', error);
        document.getElementById('post-detail').innerHTML = '<div style="color: red;">포스트 로딩 중 오류가 발생했습니다.</div>';
    }
}

// 포스트 표시
function displayPost(post) {
    const container = document.getElementById('post-detail');
    container.innerHTML = `
        <header class="post-header" style="margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
            <h1 style="color: #333; margin-bottom: 0.5rem;">${post.title}</h1>
            <div class="post-meta" style="color: #666; font-size: 0.9rem;">
                <span>작성일: ${new Date(post.created_at).toLocaleDateString('ko-KR')}</span>
                ${post.updated_at !== post.created_at ? `<span style="margin-left: 1rem;">수정일: ${new Date(post.updated_at).toLocaleDateString('ko-KR')}</span>` : ''}
            </div>
        </header>
        <div class="post-content" style="color: #333; line-height: 1.8; white-space: pre-wrap;">
            ${post.content}
        </div>
    `;
}

// 댓글 목록 로드
async function loadComments() {
    try {
        const response = await fetch(`/api/blogs/comments/?post=${postId}`);
        if (response.ok) {
            const comments = await response.json();
            displayComments(comments);
        }
    } catch (error) {
        console.error('댓글 로딩 실패:', error);
    }
}

// 댓글 표시
function displayComments(comments) {
    const container = document.getElementById('comments-list');

    if (comments.length === 0) {
        container.innerHTML = '<div style="color: #666; text-align: center; padding: 2rem;">아직 댓글이 없습니다. 첫 번째 댓글을 작성해보세요!</div>';
        return;
    }

    container.innerHTML = comments.map(comment => `
        <div class="comment-item" style="border: 1px solid #eee; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; background: #f9f9f9;">
            <div class="comment-header" style="margin-bottom: 0.5rem;">
                <strong style="color: #333;">${comment.author}</strong>
                <span style="color: #666; font-size: 0.9rem; margin-left: 1rem;">
                    ${new Date(comment.created_at).toLocaleDateString('ko-KR')}
                </span>
            </div>
            <div class="comment-content" style="color: #333; line-height: 1.6; white-space: pre-wrap;">
                ${comment.content}
            </div>
        </div>
    `).join('');
}

// 댓글 작성
document.getElementById('comment-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const author = document.getElementById('author-name').value;
    const content = document.getElementById('comment-content').value;
    const submitBtn = document.querySelector('.comment-submit-btn');
    const messageDiv = document.getElementById('comment-message');

    // 로딩 상태
    submitBtn.textContent = '작성 중...';
    submitBtn.disabled = true;

    try {
        const response = await fetch('/api/blogs/comments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({
                post: postId,
                author: author,
                content: content
            })
        });

        if (response.ok) {
            messageDiv.style.display = 'block';
            messageDiv.style.color = 'green';
            messageDiv.textContent = '댓글이 성공적으로 작성되었습니다!';

            // 폼 초기화
            document.getElementById('comment-form').reset();

            // 댓글 목록 새로고침
            setTimeout(() => {
                loadComments();
                messageDiv.style.display = 'none';
            }, 1000);
        } else {
            messageDiv.style.display = 'block';
            messageDiv.style.color = 'red';
            messageDiv.textContent = '댓글 작성에 실패했습니다.';
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.color = 'red';
        messageDiv.textContent = '댓글 작성 중 오류가 발생했습니다.';
    }

    // 버튼 상태 복원
    submitBtn.textContent = '댓글 작성';
    submitBtn.disabled = false;
});

// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', () => {
    loadPost();
});
</script>

</body>
</html>